<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<!-- 
Copyright (c) 2013, Keith Avery and Richard Macklin
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
Neither the name of GOLDMine nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->

<head>
<title>GOLDMine</title>

<style type="text/css">
/* Main page styling. */
body {
	font-family: Tahoma, sans-serif;
}

.cent {
	text-align: center;
}

.right {
	text-align: right;
}

td {
	border-style: solid;
	border-color: #AAA;
	border-width: 1px 0 0 1px;
	padding: 5px 8px;
}

table tr td:last-child {
	border-right-width: 1px;
}

table {
	border-style: solid;
	border-color: #AAA;
	border-width: 1px 1px 2px 1px;
	background-color: #F3F3F3;
	width: 100%;
}

.bold {
	font-weight: bold;
}

.alt td {
	background-color: #F9F9F9;
}

.top {
	background-color: #FFFFFF;
}



a {
	color: #000000;
}

a:hover {
	text-decoration: none;
}

.small td {
	font-size: .7em;
	color: #777;
}

.small td a {
	color: #777;
}

.medium {
	font-size: .85em;
	color: #444;
}

.medium a {
	color: #444;
}

#finals {
	display: none;
	margin-top: 5px;
}

.finalsrow td {
	font-size: .80em;
}

#quarterwhole {
	visibility: hidden;
	text-align: center;
	vertical-align: middle;
	font-size: 12px;
	margin-bottom: 5px;
}

#helpfooter {
	text-align: center;
	margin-top: 5px;
	font-size: 0.75em;
}

#helpfooter a {
	color: #666;
}

#downloadfooter {
	text-align: center;
	font-size: 0.80em;
	display: none;
	margin: 2px auto 5px auto;
}

#downloadfooter a {
	color: #666;
}

.summer td {
	font-size: .8em;
	color: #000;
}

.summer td a {
	color: #000;
}

.toprow td {
	border-top-width: 2px;
}

#header {
	text-align: center;
	font-weight: bold;
	margin: 8px auto 5px auto;
	border-top: 1px #AAA dashed;
	padding-top: 3px;
	display: none;
}

</style>

<script type="text/javascript">
<!--
// This function adds .capitalize() to string variables. It works with punctuation now, as well as roman numerals (within reason).
String.prototype.capitalize = function(){
	"use strict";
	return this.replace( /(^|\s|-|\/|&|\.|\()([a-z])/g , function(m,p1,p2){ return p1+p2.toUpperCase(); } ).replace(/( )(^|i{1,3}|iv|vi)/ig, function(m, p1, p2){ return p1+p2.toUpperCase()});
};

// Create an array of buildings mapped with the abbreviation.
var bldgs = [{abbr:"ARTS", icmname:"Arts and University Art Museum"}, {abbr:"BIOL2", icmname:"Biological Science 2"}, {abbr:"BREN", icmname:"Bren School of Environmental Science"}, {abbr:"BRDA", icmname:"Broida Hall"}, {abbr:"BUCHN", icmname:"Buchanan Hall"}, {abbr:"CAMPBHALL", icmname:"Campbell Hall"}, {abbr:"CHEM", icmname:"Chemistry"}, {abbr:"LIB", icmname:"Davidson Library"}, {abbr:"ELLSN", icmname:"Ellison Hall"}, {abbr:"EMBARHALL", icmname:"Embarcadero Hall"}, {abbr:"ENGR2", icmname:"Engineering II"}, {abbr:"ESB", icmname:"Engineering Science (ESB)"}, {abbr:"EVENTCENTR", icmname:"Events Center (Thunderdome)"}, {abbr:"WEBB", icmname:"Geological Sciences (Webb Hall)"}, {abbr:"GIRV", icmname:"Girvetz Hall"}, {abbr:"HFH", icmname:"Harold Frank Hall (Engineering I)"}, {abbr:"HSSB", icmname:"Humanities Social Sci and Performing Arts Thtr (HSSB)"}, {abbr:"IVTHEA", icmname:"Isla Vista Theater"}, {abbr:"KERR", icmname:"Kerr Hall"}, {abbr:"KOHN", icmname:"Kohn Hall and Kavli Institute"}, {abbr:"LSB", icmname:"Life Science"}, {abbr:"MLAB", icmname:"Marine Science Research Building"}, {abbr:"MRL", icmname:"Materials Research Lab"}, {abbr:"MUSIC", icmname:"Music and Lotte Lehmann Concert Hall"}, {abbr:"MUSICLLCH", icmname:"Music and Lotte Lehmann Concert Hall"}, {abbr:"NOBLE", icmname:"Noble Hall"}, {abbr:"NH", icmname:"North Hall (NH)"}, {abbr:"PHELP", icmname:"Phelps Hall"}, {abbr:"PSB-N", icmname:"Physical Science North (PSB North)"}, {abbr:"PSB-S", icmname:"Physical Sciences South (PSB South)"}, {abbr:"PSYCH", icmname:"Psychology"}, {abbr:"RECEN", icmname:"Recreation Center (RecCen)"}, {abbr:"RGYM", icmname:"Robertson Gymnasium"}, {abbr:"SH", icmname:"South Hall"}, {abbr:"SAASB", icmname:"Student Affairs and Administration Services (SAASB)"}, {abbr:"STU HLTH", icmname:"Student Health"}, {abbr:"STUHLTH", icmname:"Student Health"}, {abbr:"SRB", icmname:"Student Resource Building (SRB)"}, {abbr:"TD-W", icmname:"Theater and Dance West (TD-W)"}];
// Make a list of all the abbreviations by themselves.
var abbrevs = ["ARTS", "BIOL2", "BREN", "BRDA", "BUCHN", "CAMPBHALL", "CHEM", "LIB", "ELLSN", "EMBARHALL", "ENGR2", "ESB", "EVENTCENTR", "WEBB", "GIRV", "HFH", "HSSB", "IVTHEA", "KERR", "KOHN", "LSB", "MLAB", "MRL", "MUSIC", "MUSICLLCH", "NOBLE", "NH", "PHELP", "PSB-N", "PSB-S", "PSYCH", "RECEN", "RGYM", "SH", "SAASB", "STU HLTH", "STUHLTH", "SRB", "TD-W"];

for (var k = 0; k < bldgs.length; k++) {
	bldgs[bldgs[k].abbr] = bldgs[k];
}

// Function for buildings that aren't supported by the geology department map.
function getBldg(bldgAndRoom)
{
	"use strict";
	var bldg = bldgAndRoom.split(" ");
	if(bldg[0] === "494") {return "College of Creative Studies";}
	if(bldg[0] === "479") {return "Old Gymnasium";}
	if(bldg[0] === "ANCAP") {return "Anacapa Hall";}
	if(bldg[0] === "BSIF") {return "Biological Sciences Instructional Facility";}
	if(bldg[0] === "IVTHEA2") {return "Isla Vista Theater";}
	if(bldg[0] === "MANZ") {return "Loma Pelona";}
	if(bldg[0].indexOf("RECEN") > -1) {return "Recreation Center";}
	if(bldg[0].indexOf("RGYM") > -1) {return "Robertson Gymnasium";}
	if(bldg[0] === "SAN" && bldg[1] === "MIGEL") {return "San Miguel Hall";}
	if(bldg[0] === "SAN" && bldg[1] === "NIC") {return "San Nicolas Hall";}
	if(bldg[0] === "SAN" && bldg[1] === "RAFEL") {return "San Rafael Hall";}
	if(bldg[0] === "SANTA" && bldg[1] === "CRUZ") {return "Santa Cruz Hall";}
	if(bldg[0] === "SANTA" && bldg[1] === "ROSA") {return "Santa Rosa Hall";}
	if(bldg[0] === "TD-E") {return "Theater and Dance East";}
	if(bldg[0] === "ZODO") {return "Zodo's Bowling & Beyond";}
	return bldgAndRoom;
}

// Function to leverage the building information to build a map URL.
function getBldgURL(bldgAndRoom)
{
	"use strict";
	var bldg = bldgAndRoom.split(" ");
	var returnURL;
	if(abbrevs.indexOf(bldg[0]) > -1) { 
		returnURL = "http://map.geog.ucsb.edu/?bldg=" + bldgs[bldg[0]].icmname + "&room=" + bldg[1];
	} else {
		returnURL = "http://maps.google.com/maps?q=" + encodeURIComponent(getBldg(bldgAndRoom)) + ",+Isla+Vista,+CA";
	}
	return returnURL;
}

// Function to get the URL of an arbitrary university department.
function getDeptURL(dept)
{
	"use strict";
	if(dept==="ANTH") {return "http://www.anth.ucsb.edu";}
	if(dept==="ART CS") {return "http://www.ccs.ucsb.edu/art";}
	if(dept==="ARTHI") {return "http://www.arthistory.ucsb.edu";}
	if(dept==="ARTST") {return "http://www.arts.ucsb.edu";}
	if(dept==="AS AM") {return "http://www.asamst.ucsb.edu";}
	if(dept==="ASTRO") {return "http://web.physics.ucsb.edu/~astrogroup";}
	if(dept==="BIOL CS") {return "http://www.ccs.ucsb.edu/biology";}
	if(dept==="BL ST") {return "http://www.blackstudies.ucsb.edu";}
	if(dept==="BMSE") {return "http://www.bmse.ucsb.edu";}
	if(dept==="C LIT") {return "http://www.complit.ucsb.edu";}
	if(dept==="CH E") {return "http://www.chemengr.ucsb.edu";}
	if(dept==="CH ST") {return "http://www.chicst.ucsb.edu";}
	if(dept==="CHEM") {return "http://www.chem.ucsb.edu";}
	if(dept==="CHEM CS") {return "http://www.ccs.ucsb.edu/chem_biochem";}
	if(dept==="CHIN") {return "http://www.eastasian.ucsb.edu";}
	if(dept==="CLASS") {return "http://www.classics.ucsb.edu";}
	if(dept==="CMPSC") {return "http://www.cs.ucsb.edu";}
	if(dept==="CMPSCCS") {return "http://cs.ucsb.edu/~ccs";}
	if(dept==="CNCSP") {return "http://education.ucsb.edu/Graduate-Studies/CCSP/CCSP-home.html";}
	if(dept==="COMM") {return "http://www.comm.ucsb.edu";}
	if(dept==="DANCE") {return "http://www.theaterdance.ucsb.edu";}
	if(dept==="EACS") {return "http://www.eastasian.ucsb.edu";}
	if(dept==="EARTH") {return "http://www.geol.ucsb.edu";}
	if(dept==="ECE") {return "http://www.ece.ucsb.edu";}
	if(dept==="ECON") {return "http://www.econ.ucsb.edu";}
	if(dept.indexOf("ED")>=0) {return "http://www.education.ucsb.edu";}
	if(dept==="EEMB") {return "http://www.lifesci.ucsb.edu";}
	if(dept==="ENGL") {return "http://www.english.ucsb.edu";}
	if(dept==="ENGR") {return "http://engineering.ucsb.edu";}
	if(dept==="ENV S") {return "http://www.es.ucsb.edu";}
	if(dept==="ES") {return "http://essr.sa.ucsb.edu";}
	if(dept==="ESM") {return "http://www.bren.ucsb.edu";}
	if(dept==="ESS") {return "http://essr.sa.ucsb.edu";}
	if(dept==="FEMST") {return "http://www.femst.ucsb.edu";}
	if(dept==="FLMST") {return "http://www.filmandmedia.ucsb.edu";}
	if(dept==="FR") {return "http://www.frit.ucsb.edu";}
	if(dept==="GEOG") {return "http://www.geog.ucsb.edu";}
	if(dept==="GEOL") {return "http://www.geol.ucsb.edu";}
	if(dept==="GER") {return "http://www.gss.ucsb.edu";}
	if(dept==="GLOBL") {return "http://www.global.ucsb.edu";}
	if(dept==="GPS") {return "http://www.global.ucsb.edu/programs/gps";}
	if(dept==="GREEK") {return "http://www.classics.ucsb.edu";}
	if(dept==="HEB") {return "http://www.gss.ucsb.edu";}
	if(dept==="HIST") {return "http://www.history.ucsb.edu";}
	if(dept==="INT") {return "http://www.advising.ltsc.ucsb.edu/freshman";}
	if(dept==="ITAL") {return "http://www.frit.ucsb.edu";}
	if(dept==="JAPAN") {return "http://www.eastasian.ucsb.edu";}
	if(dept==="KOR") {return "http://www.eastasian.ucsb.edu";}
	if(dept==="LAIS") {return "http://www.lais.ucsb.edu";}
	if(dept==="LATIN") {return "http://www.classics.ucsb.edu";}
	if(dept==="LING") {return "http://www.linguistics.ucsb.edu";}
	if(dept==="LIT CS") {return "http://www.ccs.ucsb.edu/literature";}
	if(dept==="MARSC") {return "http://www.igpms.ucsb.edu";}
	if(dept==="MAT") {return "http://www.mat.ucsb.edu";}
	if(dept==="MATH") {return "http://www.math.ucsb.edu";}
	if(dept==="MATH CS") {return "http://ccs.math.ucsb.edu";}
	if(dept==="MATH WKL") {return "http://www.math.ucsb.edu";}
	if(dept==="MATRL") {return "http://www.materials.ucsb.edu";}
	if(dept==="MCDB") {return "http://www.lifesci.ucsb.edu";}
	if(dept==="ME") {return "http://www.me.ucsb.edu";}
	if(dept==="ME ST") {return "http://medievalstudies.ucsb.edu";}
	if(dept==="MES") {return "http://www.cmes.ucsb.edu";}
	if(dept==="MS") {return "http://www.milsci.ucsb.edu";}
	if(dept==="MUS") {return "http://www.music.ucsb.edu";}
	if(dept==="MUS CS") {return "http://www.ccs.ucsb.edu/music";}
	if(dept==="MUS A") {return "http://www.music.ucsb.edu";}
	if(dept==="PHIL") {return "http://www.philosophy.ucsb.edu";}
	if(dept==="PHYS") {return "http://www.physics.ucsb.edu";}
	if(dept==="PHYS CS") {return "http://www.ccs.ucsb.edu/physics";}
	if(dept==="POL S") {return "http://www.polsci.ucsb.edu";}
	if(dept==="PORT") {return "http://www.spanport.ucsb.edu";}
	if(dept==="PSTAT") {return "http://www.pstat.ucsb.edu";}
	if(dept==="PSY") {return "http://www.psych.ucsb.edu";}
	if(dept==="RENST") {return "http://www.renaissancestudies.ucsb.edu";}
	if(dept==="RG ST") {return "http://www.religion.ucsb.edu";}
	if(dept==="SHS") {return "http://www.speech.ucsb.edu";}
	if(dept==="SLAV") {return "http://www.gss.ucsb.edu";}
	if(dept==="SOC") {return "http://www.soc.ucsb.edu";}
	if(dept==="SPAN") {return "http://www.spanport.ucsb.edu";}
	if(dept==="THTR") {return "http://www.theaterdance.ucsb.edu";}
	if(dept==="WRIT") {return "http://www.writing.ucsb.edu";}
	
	return ("http://www.google.com/search?q=ucsb+" + dept +"+department");
}

// Comparison function for quarters.
function compareQuarters(quarter1, quarter2) {
	"use strict";
	// Split into quarter name and year.
	var split1 = quarter1.split(" ");
	var split2 = quarter2.split(" ");
	
	// Get years.
	var year1 = parseInt(split1[1],10);
	var year2 = parseInt(split2[1],10);
	
	// Get quarter names.
	var name1 = split1[0];
	var name2 = split2[0];
	
	// If the years are different, that is sufficient for determining which quarter is first.
	if (year1 !== year2) {
		return year2 - year1;
	} else {
		// Otherwise, compare for each quarter.
		if (name1 === "Fall") {
			// Fall is the last quarter always.
			return -1;
		} else if (name1 === "Winter") {
			// Winter is always the first quarter.
			return 1;
		} else if (name1 === "Spring") {
			// Spring is after winter, but before all the others.
			if (name2 === "Winter") {
				return -1;
			} else {
				return 1;
			}
		} else if (name1 === "Summer") {
			// Summer is before fall, but after all the others.
			if (name2 === "Fall") {
				return 1;
			} else {
				return -1;
			}
		}
	}
}

// Function to update the quarter selection control.
function updateSelect() {
	"use strict";
	// Get the control and its selected index.
	var select = document.getElementById("quarter");
	var selected = select.selectedIndex;
	
	// Reset the control to have no options.
	select.options.length = 0;
	
	// Get the local data, for all quarters.
	var local = JSON.parse(localStorage.getItem("mainarray"));
	
	// Get the keys for the local data (quarter names).
	var keys = [];
	for (var key in local) {
		if (local.hasOwnProperty(key)) {
			keys.push(key);
		}
	}
	
	// Sort the quarter names.
	keys.sort(compareQuarters);
	
	// Add each quarter name to the control.
	for (var i = 0; i < keys.length; i++) {
		var option = document.createElement("option");
		option.text = keys[i];
		select.add(option,null);
	}
	
	// If the selected index we saw at the beginning was valid, select that index again (for persistent selection).
	if (selected < 0 || selected > select.options.length) {
		selected = 0;
	}
	select.selectedIndex = selected;
	
	if (select.options.length > 0) {
		document.getElementById("quarterwhole").style.visibility = "visible";
	} else {
		document.getElementById("quarterwhole").style.visibility = "hidden";
	}
}

// str is an HTML/string version of the class schedule (output to the user in this popover).
var str = "";

// finalStr is an HTML/string version of the final schedule.
var finalStr = "";
// haveFinals is a boolean which tells us whether we have finals for this quarter (past quarters don't have final information).
var haveFinals;

// This function responds to messages sent from other places in the browser runtime.
function respondToMessage(theMessageEvent) {
	"use strict";
	// We are only interested in "classData" messages, and we want to ignore the rest.
	if(theMessageEvent.name === "classData") {
		// Get the message's data and store it.
		var mainarray = theMessageEvent.message;
		
		// Get the local data, consisting of multiple quarters.
		var local = JSON.parse(localStorage.getItem("mainarray"));
		
		// Get the quarter we got data for.
		var quarter = mainarray[0];
		
		// If we didn't find local data, or the local data is not an assoc. array, make a new one.
		if (!local || (local.constructor !== Object)) {
			local = {};
		}
		
		// Set the quarter that we got data for.
		local[quarter] = mainarray.slice(1);
		
		// Save back to the local data storage.
		localStorage.setItem("mainarray", JSON.stringify(local));
		
		// Update the quarter select control.
		updateSelect();
		
		// Update the popover with that data.
		update(local);
	}
}

// This function updates the popover given an array of data.
function update(mainarray) {
	"use strict";
	// Initial height is 90, which is the height of the select element, the download link, the help link, and the quarter header.
	var height = 90;
	// Initially, we have no final information.
	haveFinals = false;
	var finalList = [];

	// main is the element (a table) that we will insert our data into to display it to the user.
	var main = document.getElementById("main");

	// finals is the element (a table) that we will insert final exam information into.
	var finals = document.getElementById("finals");
	
	// Get the quarter selection control and find the selected quarter.
	var select = document.getElementById("quarter");
	var quarter = select.options[select.selectedIndex].text;
	
	var header = document.getElementById("header");
	header.innerHTML = quarter;
	header.style.display = "block";

	// Get the data for the quarter.
	mainarray = mainarray[quarter];

	// Start the string, and include the quarter that the popover is listing. The quarter is stored in the first element of the data passed.
	str = "<tr><td colspan='4' class='cent bold top'>Class List</td></tr>";
	finalStr = "<tr><td colspan='4' class='cent bold top'>Final Exams</td></tr>";

	// Add the height of the header to the height.
	height += 30;
	
	// Loop through each class.
	for (var i = 0; i < mainarray.length; i++) {
		// Alternate colours for the table rows and the final table row.
		if (i % 2 === 1) {
			str += "<tr class='alt toprow'>";
			finalStr += "<tr class='finalsrow alt'>";
		} else {
			str += "<tr class='toprow'>";
			if (i === 0) {
				finalStr += "<tr class='finalsrow toprow'>";
			} else {
				finalStr += "<tr class='finalsrow'>";
			}
		}

		// Add a table row for each class, with its department (mainarray[i][0]), number (mainarray[i][1]), and name (mainarray[i][2]).
		str += "<td class='right'>" + "<a href='" + getDeptURL(mainarray[i].department) + "' target='_blank'>" + mainarray[i].department + "</a>" + "</td><td class='cent'>" + mainarray[i].number + "</td>";
		str += "<td colspan='2'>" + mainarray[i].courseName.toLowerCase().capitalize() + "</td></tr>";
		height += 32;

		// Add the department and class to the final table content.
		finalStr += "<td class='right'>" + "<a href='" + getDeptURL(mainarray[i].department) + "' target='_blank'>" + mainarray[i].department + "</a>" + "</td><td class='cent'>" + mainarray[i].number + "</td>";
		
		// If we have summer session information
		if (mainarray[i].summer) {
			// Add the summer session row height
			height += 27;
			
			// Use alternate colors, like class main row
			if (i % 2 === 1) {
				str += "<tr class='alt summer'>";
			} else {
				str += "<tr class='summer'>";
			}
			
			// Add the summer session information
			str += "<td colspan='4' class='cent'>" + mainarray[i].summer + "</td>";
			str += "</tr>";
		}

		// Loop through the array of meeting times for the class (mainarray[i][3]). We increment j by 3 each time, because we've stored 3 elements in the array for each meeting time.
		for (var j = 0; j < mainarray[i].meetingTimes.length; j++) {
			// Use the same color as the class main row.
			if (i % 2 === 1) {
				str += "<tr class='alt small'>";
			} else {
				str += "<tr class='small'>";
			}

			// Add a table row for each meeting time, with its day, time, and room number. We use j as the offset of the first value for this meeting time
			//	and add another offset to that (ranging 0-2) to get to the data we need. Every third value is the day value of another class meeting time.
			str += "<td class='right'>" + mainarray[i].meetingTimes[j].day + "</td><td class='cent'>" + mainarray[i].meetingTimes[j].meetingTime + "</td>";
			str += "<td>" + "<a href=\"" + getBldgURL(mainarray[i].meetingTimes[j].room) +"\" target='_blank'>" + mainarray[i].meetingTimes[j].room + "</a>" + "</td>";
			// Add the last table cell for each row.
			str += "<td>";
			// Check if there is an instructor for this row.
			if (j < mainarray[i].instructor.length) {
				// Get the instructor.
				var instructor = mainarray[i].instructor[j].toLowerCase().capitalize();
				// Get the instructor's last name (for RateMyProfessor).
				var lastname = instructor.split(" ",1)[0];
				// Check if the last name is usable (it's not empty or one character, and it doesn't have a period).
				if ((lastname.length > 1) && (lastname.indexOf(".") < 0)) {
					// Add a link to RateMyProfessor, searching by the last name.
					str += "<a href='" + "http://www.ratemyprofessors.com/search.jsp?query=" + lastname + "+University+California+Santa+Barbara'>";
				}
				// Output the instructor.
				str += mainarray[i].instructor[j].toLowerCase().capitalize();
				// If we started a link, finish it.
				if ((lastname.length > 1) && (lastname.indexOf(".") > -1)) {
					str += "</a>";
				}
			}
			// Finish the cell, and the row.
			str += "</td></tr>";
			// Add the height of this row to the height.
			height += 24;
		}

		// Add the final time to the final table content.
		finalStr += "<td colspan='2'>" + mainarray[i].finalT + "</td></tr>";

		// If the final is defined, we do have finals.
		if (mainarray[i].finalT) {
			// Add this row to the height.
			height += 27;
			// Update our final boolean to show that we do have finals.
			haveFinals = true;
			
			// If there is a valid final date and time, rather than no final or contact professor
			if (/[a-zA-Z]+, [a-zA-Z]+ [0-9]{1,2}, [0-9]{4}/.test(mainarray[i].finalT)) {
				// Add it to the list
				finalList[i] = mainarray[i].finalT;
			} else {
				// Otherwise add an empty string placeholder
				finalList[i] = "";
			}
		}
	}

	// Set the table's content to our new content string.
	main.innerHTML = str;

	var download = document.getElementById("downloadfooter");

	// If we have finals, show the table, otherwise hide it.
	if (haveFinals) {
		// Add the finals header to the height.
		height += 27;
		// Show the finals table.
		finals.style.display = "table";
		// Set the finals content to the string.
		finals.innerHTML = finalStr;
		
		// Parse the times using the finals list, and create iCalendar data
		parseTimes(finalList);
		
		// Display the download link
		download.style.display = "block";
	} else {
		// Hide the final table and reset its content.
		finals.style.display="none";
		finals.innerHTML = "";
		
		// Hide the download link (no .ics generated if there are no finals
		download.style.display = "none";
		
		// If we are not displaying the download link, remove its height
		height -= 16;
	}

	// Set the popover height to the computed height.
	safari.self.height = Math.max(height + 34, 360);
}


// Makes this page listen for messages in the runtime.
safari.application.addEventListener("message",respondToMessage,false);

// Function to open links in new tabs.
function manageLinks(event) {
	"use strict";
	if (event.target.href) {
		// Get the active tab and an array of all the tabs.
		var activeTab = safari.application.activeBrowserWindow.activeTab;
		var alltabs = safari.application.activeBrowserWindow.tabs;
		
		// Set the default opening location to the far right.
		var index = alltabs.length;
		
		// Go through all the tabs.
		for (var i = 0; i < alltabs.length; i++) {
			// If we found the active tab, save it's index.
			if (alltabs[i] === activeTab) {
				index = i+1;
			}
		}
	
		// Open a new tab to the right of the active tab (or defaulting to the far right).
		var tab = safari.application.activeBrowserWindow.openTab('foreground',index);
		// Load the link's url in the new tab.
		tab.url = event.target.href;
		
		// Get all the popovers currently in the browser.
		var popovers = safari.extension.popovers;
		
		// Go through all the popovers, and hide them.
		for (var j = 0; j < popovers.length; j++) {
			popovers[j].hide();
		}
	}
	
	return false;
}

// Make sure the page calls the function to handle links.
document.onclick=manageLinks;

// Quarter selection control changed, update the page.
function selectChanged() {
	"use strict";
	var mainarray = JSON.parse(localStorage.getItem("mainarray"));
	if (mainarray) {
		update(mainarray);
	}
}

// Function that updates the select control and updates the page, called before the page is shown.
function initial() {
	"use strict";
	updateSelect();
	selectChanged();
}

// Function to split the GOLD days string and return an array of real day names
function getDays(daysString) {
	var dayLookup = {"M": "Monday", "T": "Tuesday", "W": "Wednesday", "R": "Thursday", "F": "Friday", "S": "Saturday", "U": "Sunday"};
	var dayStrings = daysString.split(" ");
	var days = [];
	for (var i = 0; i < dayStrings.length; i++) {
		days.push(dayLookup[dayStrings[i]]);
	}
	return days;
}

// Function to take a time interval string and split it into two times
function getInterval(timeString) {
	var split = timeString.replace(/[^APM0-9:\-]/g, '').split("-");
	return [split[0], split[1]];
}

// Function to take a string that represents a class time, a string which represents the day of the week that it meets,
//   and a final string and return a relative date object with respect to 10 weeks before finals
function makeRelativeDate(stringTime, day, finalString) {
	// Lookup arrays for the long dates and months, to translate into javascript date object numbers
	var dayLookup = {"Monday": 1, "Tuesday" : 2, "Wednesday": 3, "Thursday": 4, "Friday" : 5, "Saturday": 6, "Sunday": 0};
	var monthLookup = {"January": 0, "February": 1, "March": 2, "April": 3, "May": 4, "June": 5, "July": 6, "August": 7, "September": 8, "October": 9, "November": 10, "December": 11};
	
	// Get the current date
	var currentDate = new Date();

	// Initialization
	var split;
	var seconds;
	
	// Check if the final string we got actually has a date/time in it
	var matches = finalString.match(/[a-zA-Z]+, [a-zA-Z]+ [0-9]{1,2}, [0-9]{4}/g);
	if (matches && matches.length > 0) {
		// If it does, use that date and time to create a new date. First remove commas
		var finalTime = matches[0].replace(/,/g,'');
		// Split into tokens
		split = finalTime.split(" ");
		// Create the date from that final date
		currentDate = new Date(parseInt(split[3], 10), monthLookup[split[1]], parseInt(split[2], 10), 12, 0, 0, 0);
		
		// Use the unix timestamp fields to subtract 10 weeks from that date
		seconds = currentDate.getTime();
		seconds -= 10 * 7 * 24 * 60 * 60 * 1000;
		
		// Use that date instead of the current date
		currentDate = new Date(seconds);
	}
	
	// Make the date the correct day of the week, while keeping it in the same week of the year, using the unix timestamp field
	seconds = currentDate.getTime();
	var currentDay = currentDate.getDay();
	
	// Subtract the difference in days (in milliseconds), this can be negative or positive depending on whether the new date is before or after
	seconds += 24 * 60 * 60 * (dayLookup[day] - currentDay) * 1000;
	// Create a relative date
	var relative = new Date(seconds);
	
	// Get the time part, and split into hours and minutes based on the colon
	split = stringTime.split(":");
	// Get the hour
	var hour = parseInt(split[0], 10);
	// Get the minute (disregarding the last two characters, as they are the AM/PM)
	var minute = parseInt(split[1].substr(0,2), 10);
	
	// If we are in PM, add tweleve hours
	if (split[1].substr(2, 2) === "PM") {
		// Except if it is noon
		if (hour !== 12) {
			hour += 12;
		}
	} else if (hour === 12) {
		// If we are at mightnight (hour is 12 and we are not PM, which is AM), then subtract 12 hours to take us to zero
		hour -= 12;
	}
	
	// Set the time component
	relative.setHours(hour);
	relative.setMinutes(minute);
	relative.setSeconds(0);
	relative.setMilliseconds(0);
	
	// Return the new relative date
	return relative;
}

// Similar function to previous, but makes a time relative to finals week, rather than ten weeks before it. Takes a parameter which determines whether we get the starting or ending time of the final
function makeFinalsWeekTime(finalString, start) {
	// Lookup arrays for the long months, to translate into javascript date object numbers
	var monthLookup = {"January": 0, "February": 1, "March": 2, "April": 3, "May": 4, "June": 5, "July": 6, "August": 7, "September": 8, "October": 9, "November": 10, "December": 11};
	
	// Get the date/time from the final string
	var matches = finalString.match(/[a-zA-Z]+, [a-zA-Z]+ [0-9]{1,2}, [0-9]{4}/g);
	
	// Remove commas
	var finalTime = matches[0].replace(/,/g,'');
	// Split into tokens
	var split = finalTime.split(" ");
	
	// Create the date from that final date
	var relative = new Date(parseInt(split[3], 10), monthLookup[split[1]], parseInt(split[2], 10), 12, 0, 0, 0);
	
	// Get the starting and ending times
	split = finalString.match(/[0-9]{1,2}:[0-9]{2} (AM|PM)/g);
	
	// Check if we are returning the start time or the end time
	if (start) {
		// If start, use the first one
		split = split[0].split(":");
	} else {
		// If end, use the second one
		split = split[1].split(":");
	}
	
	// Get the hour
	var hour = parseInt(split[0], 10);
	
	// Get the minute (disregarding the last three characters, as they are the AM/PM)
	var minute = parseInt(split[1].substr(0,2), 10);
	
	// If we are in PM, add tweleve hours
	if (split[1].substr(3, 2) === "PM") {
		// Except if it is noon
		if (hour !== 12) {
			hour += 12;
		}
	} else if (hour === 12) {
		// If we are at mightnight (hour is 12 and we are not PM, which is AM), then subtract 12 hours to take us to zero
		hour -= 12;
	}
	
	// Set the time component
	relative.setHours(hour);
	relative.setMinutes(minute);
	relative.setSeconds(0);
	relative.setMilliseconds(0);
	
	// Return the new relative date
	return relative;
}

// Function to make sure a number is two-digits, needed for iCalendar date fields
function makeTwoDigit(num) {
	// If less than ten, add a leading zero, otherwise just return the string version
	if (num < 10) {
		return "0" + num;
	} else {
		return "" + num;
	}
}

// Function to take a date object and return an iCalendar date string (format yyyymmddThhmmss)
function makeICalDate(date) {
	// Get the date fields, and ensure that they are two digit (except year, which must be four, which is what getfullyear returns anyways)
	var string = "" + date.getFullYear() + makeTwoDigit(date.getMonth() + 1) + makeTwoDigit(date.getDate());
	// Get the time fields, and ensure that they are two digit
	string += "T" + makeTwoDigit(date.getHours()) + makeTwoDigit(date.getMinutes()) + makeTwoDigit(date.getSeconds());
	// Return that string
	return string;
}

// Function to make an iCalendar file from a list of course times and finals
function makeICalendar(timeList, finalStrings) {
	
	// Find the first final time that is a valid string, and save it
	var validFinal = "";
	for (var i = 0; i < finalStrings.length; i++) {
		// Check if the current is empty and the one we are looking at is not empty
		if (validFinal === "" && finalStrings[i] !== "") {
			// Save it, and finish the loop
			validFinal = finalStrings[i];
			break;
		}
	}
	
	// Arrays to store the course names and locations
	var courseNames = [];
	var courseLocations = [];
	
	
	// Start the string with the iCalendar file header
	var icalString =
	'BEGIN:VCALENDAR\n' +
	'VERSION:2.0\n' +
	'PRODID:com.kpavery.GOLDMine\n' +
	'METHOD:PUBLISH\n';
	
	// Loop through the course meeting times
	for (var i = 0; i < timeList.length; i++) {
		// Get tht time
		var time = timeList[i];
		
		// If we don't have this courses information saved
		if (courseNames.indexOf(time.courseName) < 0) {
			// Save the name and location
			courseNames.push(time.courseName);
			courseLocations.push(time.room);
		}
		
		// If we have no times, then do not process this course meeting time (as we have no calendar information
		if (time.days.length < 1 || !time.days[0]) {
			continue;
		}
		
		// Handle discussion sections
		var section = "";
		// If we are not the first meeting time for this course, and we are the last meeting time for this course, we are a section
		if (((i !== 0) && (timeList[i-1].courseName === timeList[i].courseName)) && ((i === timeList.length - 1) || (timeList[i].courseName !== timeList[i+1].courseName))) {
			// Add a string accordingly
			section = " Section";
		}
		
		// Add the event field for this course meeting time to the iCalendar string, handling dates, sections, repeating course times, and locations
		icalString +=
		'BEGIN:VEVENT\n' +
		'UID:' + ((new Date().getTime()) + i) + '@' + 'GOLDMine' + '\n' +
		'DTSTAMP:' + makeICalDate(new Date()) + '\n' +
		'SUMMARY:' + time.courseName + section + '\n' +
		'DTSTART:' + makeICalDate(makeRelativeDate(time.startTime, time.days[0], validFinal)) + '\n' +
		'RRULE:FREQ=WEEKLY;COUNT=' + (time.days.length * 10) + ';INTERVAL=1;BYDAY=';
		for (var j = 0; j < time.days.length; j++) {
			icalString += time.days[j].substr(0,2).toUpperCase();
			if (j !== time.days.length - 1) {
				icalString += ",";
			}
		}
		icalString += ';WKST=SU' + '\n' +
		'DTEND:' + makeICalDate(makeRelativeDate(time.endTime, time.days[0], validFinal)) + '\n' +
		'LOCATION:' + time.room + '\n' +
		'END:VEVENT\n';		
	}
	
	// Now add all the finals that we have information for to the iCalendar string. Loop through the final times
	for (var i = 0; i < finalStrings.length; i++) {
		// If this is a valid final, then add an event
		if (finalStrings[i] !== "") {
			// Add the event handling dates. We use the course name and location lookups for the name of the final and the location.
			icalString +=
			'BEGIN:VEVENT\n' +
			'UID:' + ((new Date().getTime()) + i + timeList.length) + '@' + 'GOLDMine' + '\n' +
			'DTSTAMP:' + makeICalDate(new Date()) + '\n' +
			'SUMMARY:' + courseNames[i] + " Final" + '\n' +
			'DTSTART:' + makeICalDate(makeFinalsWeekTime(finalStrings[i], true)) + '\n' +
			'DTEND:' + makeICalDate(makeFinalsWeekTime(finalStrings[i], false)) + '\n' +
			'LOCATION:' + courseLocations[i] + '\n' +
			'END:VEVENT\n';
		}
	}
	
	// Finish the iCalendar string and return it
	icalString += 'END:VCALENDAR';
	return icalString;
}

// Function to take a quarter, and a string of finals, and make an iCalendar downloadable file
function parseTimesForQuarter(quarter, finalStrings) {
	// Get the data for the given quarter
	var mainarray = JSON.parse(localStorage.getItem("mainarray"))[quarter];
	// If it was found, then process it
	if (mainarray) {
		// First get the times and relevant information from the quarter data
		var timeList = [];
		// Loop through each course
		for (var i = 0; i < mainarray.length; i++) {
			// Get its name
			var courseName = mainarray[i].department + " " + mainarray[i].number.replace(/\s/g,'');
			// Loop through its meeting times, as we add each separately
			var meetingTimes = mainarray[i].meetingTimes;
			for (var j = 0; j < meetingTimes.length; j++) {
				// Get the room
				var room = meetingTimes[j].room;
				
				// Get the class time string, and create two times (an interval) from it
				var classTime = meetingTimes[j].meetingTime;
				var interval = getInterval(classTime);
				// Get the start and end time from the interval
				var startTime = interval[0];
				var endTime = interval[1];
				
				// Get the meeting days
				var days = getDays(meetingTimes[j].day);
				
				// Create a course meeting object and add it to the meeting time list
				var meeting = {'courseName': courseName, 'days': days, 'startTime': startTime, 'endTime': endTime, 'room': room};
				timeList.push(meeting);
			}
		}
		
		// Use the created meeting time list to generate an iCalendar string, using the final strings passed
		var ical = makeICalendar(timeList, finalStrings);
		
		// Add the download link for the iCalendar string. First find the download link element
		var download = document.getElementById("download");
		// Then create a download link that uses the PHP script and the iCalendar file as a URI parameter to download the file
		download.href = "http://kpavery.com/goldmine.php?data=" + encodeURIComponent(encodeURI(ical));
	}
}

// Function to parse times for the current quarter, given final strings
function parseTimes(finalStrings) {
	// Get the quarter selection dropdown, and then the current quarter
	var select = document.getElementById("quarter");
	var quarter = select.options[select.selectedIndex].text;
	// Parse times for that quarter
	parseTimesForQuarter(quarter, finalStrings);
}

// Tell Safari to attempt to get data from local storage and update the popover before displaying it.
safari.application.addEventListener("popover",initial,false);

-->
// The HTML below is the page structure, and the default text (that is displayed when no course data has been loaded).
</script>
</head>
<body>
<div id="quarterwhole">
Select quarter: <select id="quarter" onchange="selectChanged();">
<option></option>
</select>
</div>
<div id="header"></div>
<div id="downloadfooter"><a href="" id="download">Download Schedule</a></div>
<table id="main" cellspacing="0">
<tr><td class='cent'>Please go to your course schedule page in GOLD (or reload it if you are already there).</td></tr>
</table>
<table id="finals" cellspacing="0">
<tr><td class='cent'></td></tr>
</table>
<div id="helpfooter"><a href="http://kpavery.github.io/goldmine/#help">Help</a></div>
</body>
</html>
